<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - EduHub</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="bg-glow"></div>

    <!-- Navbar -->
    <nav class="navbar">
        <div style="display:flex; align-items:center; gap:12px;">
            <img src="/static/images/LOGO_WHITE.png" style="width:32px; height:32px; object-fit:contain;">
            <span style="font-weight:700; font-size:20px;">EduHub</span>
        </div>
        <div style="display:flex; align-items:center; gap:20px;">
            <a href="/browse" style="color:#ccc; text-decoration:none; transition:color 0.3s;">Browse</a>
            <a href="/upload" style="color:#ccc; text-decoration:none; transition:color 0.3s;">Upload</a>
            <a href="/community" style="color:#ccc; text-decoration:none; transition:color 0.3s;">Community</a>
            <a href="/leaderboard" style="color:#ccc; text-decoration:none; transition:color 0.3s;">Leaderboard</a>
            <a href="/ocr" style="color:#ccc; text-decoration:none; transition:color 0.3s;">OCR</a>
            <div
                style="width:36px; height:36px; border-radius:50%; background:#0F5257; overflow:hidden; border:2px solid #55D6BE; display:flex; align-items:center; justify-content:center;">
                <span id="nav-initial" style="font-weight:700; color:#55D6BE; font-size:14px;">U</span>
            </div>
            <button onclick="logout()"
                style="background:none; border:none; color:#999; cursor:pointer; font-size:16px;"><i
                    class="fas fa-sign-out-alt"></i></button>
        </div>
    </nav>

    <!-- Main Content -->
    <main style="min-height:calc(100vh - 64px); padding:32px; padding-top:96px;">
        <div style="max-width:1100px; margin:0 auto;">
            <!-- Welcome -->
            <div style="margin-bottom:40px;">
                <h1 style="font-size:36px; margin-bottom:8px;">Hello, <span id="user-name"
                        style="color:#55D6BE;">Learner</span>!</h1>
                <p style="color:#999;">Ready to share some knowledge today?</p>
            </div>

            <!-- Stats -->
            <div
                style="display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); gap:20px; margin-bottom:40px;">
                <div class="stat-card">
                    <div style="display:flex; align-items:center; justify-content:space-between;">
                        <div>
                            <p style="color:#999; font-size:11px; text-transform:uppercase;">EduTokens</p>
                            <p id="stat-tokens" style="font-size:28px; font-weight:700; margin-top:4px; color:#55D6BE;">
                                0</p>
                        </div>
                        <i class="fas fa-coins" style="color:#f59e0b; font-size:24px; opacity:0.6;"></i>
                    </div>
                </div>
                <div class="stat-card" style="border-left-color:#a855f7;">
                    <div style="display:flex; align-items:center; justify-content:space-between;">
                        <div>
                            <p style="color:#999; font-size:11px; text-transform:uppercase;">Explore Score</p>
                            <p id="stat-explore"
                                style="font-size:28px; font-weight:700; margin-top:4px; color:#a855f7;">0</p>
                        </div>
                        <i class="fas fa-compass" style="color:#a855f7; font-size:24px; opacity:0.6;"></i>
                    </div>
                </div>
                <div class="stat-card" style="border-left-color:#0F5257;">
                    <div style="display:flex; align-items:center; justify-content:space-between;">
                        <div>
                            <p style="color:#999; font-size:11px; text-transform:uppercase;">My Resources</p>
                            <p id="stat-resources" style="font-size:28px; font-weight:700; margin-top:4px;">0</p>
                        </div>
                        <i class="fas fa-book" style="color:#55D6BE; font-size:24px; opacity:0.5;"></i>
                    </div>
                </div>
                <div class="stat-card" style="border-left-color:#0F5257;">
                    <div style="display:flex; align-items:center; justify-content:space-between;">
                        <div>
                            <p style="color:#999; font-size:11px; text-transform:uppercase;">College</p>
                            <p id="stat-college" style="font-size:16px; font-weight:700; margin-top:4px;">‚Äî</p>
                        </div>
                        <i class="fas fa-university" style="color:#55D6BE; font-size:24px; opacity:0.5;"></i>
                    </div>
                </div>
            </div>

            <!-- Token History -->
            <div class="glass-card" style="border-radius:12px; padding:24px; margin-bottom:24px;">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;">
                    <h3 style="font-weight:700; font-size:18px;"><i class="fas fa-history"
                            style="color:#55D6BE; margin-right:8px;"></i>Recent Token Activity</h3>
                    <a href="/leaderboard" style="color:#55D6BE; font-size:13px; text-decoration:none;">View Leaderboard
                        ‚Üí</a>
                </div>
                <div id="token-history" style="display:flex; flex-direction:column; gap:8px;">
                    <p style="color:#666; font-size:14px; text-align:center; padding:16px;">Loading...</p>
                </div>
            </div>

            <!-- Quick Actions -->
            <div
                style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:20px; margin-bottom:40px;">
                <a href="/upload" style="text-decoration:none; color:white;">
                    <div class="glass-card"
                        style="border-radius:12px; padding:24px; cursor:pointer; border:1px solid transparent; transition:border-color 0.3s;"
                        onmouseover="this.style.borderColor='#55D6BE'"
                        onmouseout="this.style.borderColor='transparent'">
                        <div style="display:flex; align-items:center; gap:16px;">
                            <div
                                style="width:48px; height:48px; border-radius:12px; background:rgba(85,214,190,0.2); display:flex; align-items:center; justify-content:center;">
                                <i class="fas fa-upload" style="color:#55D6BE; font-size:20px;"></i>
                            </div>
                            <div>
                                <h3 style="font-size:18px; font-weight:700;">Upload Resource</h3>
                                <p style="color:#999; font-size:13px;">+10 tokens per safe upload</p>
                            </div>
                        </div>
                    </div>
                </a>
                <a href="/browse" style="text-decoration:none; color:white;">
                    <div class="glass-card"
                        style="border-radius:12px; padding:24px; cursor:pointer; border:1px solid transparent; transition:border-color 0.3s;"
                        onmouseover="this.style.borderColor='#55D6BE'"
                        onmouseout="this.style.borderColor='transparent'">
                        <div style="display:flex; align-items:center; gap:16px;">
                            <div
                                style="width:48px; height:48px; border-radius:12px; background:rgba(15,82,87,0.5); display:flex; align-items:center; justify-content:center;">
                                <i class="fas fa-search" style="color:#55D6BE; font-size:20px;"></i>
                            </div>
                            <div>
                                <h3 style="font-size:18px; font-weight:700;">Browse Resources</h3>
                                <p style="color:#999; font-size:13px;">+1 token per view</p>
                            </div>
                        </div>
                    </div>
                </a>
                <a href="/ocr" style="text-decoration:none; color:white;">
                    <div class="glass-card"
                        style="border-radius:12px; padding:24px; cursor:pointer; border:1px solid transparent; transition:border-color 0.3s;"
                        onmouseover="this.style.borderColor='#a855f7'"
                        onmouseout="this.style.borderColor='transparent'">
                        <div style="display:flex; align-items:center; gap:16px;">
                            <div
                                style="width:48px; height:48px; border-radius:12px; background:rgba(168,85,247,0.2); display:flex; align-items:center; justify-content:center;">
                                <i class="fas fa-eye" style="color:#a855f7; font-size:20px;"></i>
                            </div>
                            <div>
                                <h3 style="font-size:18px; font-weight:700;">OCR ‚Äî Image to Text</h3>
                                <p style="color:#999; font-size:13px;">+2 tokens per extraction</p>
                            </div>
                        </div>
                    </div>
                </a>
            </div>

            <!-- My Recent Resources -->
            <div class="glass-card" style="border-radius:12px; padding:24px;">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
                    <h3 style="font-weight:700; font-size:18px;">My Recent Uploads</h3>
                    <a href="/browse" style="color:#55D6BE; font-size:13px; text-decoration:none;">View all ‚Üí</a>
                </div>
                <div id="my-resources" style="display:flex; flex-direction:column; gap:12px;">
                    <p style="color:#666; font-size:14px; text-align:center; padding:24px;">Loading...</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        const token = localStorage.getItem('eduhub_token');
        if (!token) window.location.href = '/login';

        async function authFetch(url, options = {}) {
            options.headers = options.headers || {};
            options.headers['Authorization'] = 'Bearer ' + token;
            return fetch(url, options);
        }

        function logout() {
            localStorage.removeItem('eduhub_token');
            localStorage.removeItem('eduhub_user');
            window.location.href = '/login';
        }

        const REASON_LABELS = {
            'safe_upload': 'üì§ Safe Upload',
            'malware_report': 'üõ°Ô∏è Malware Reported',
            'daily_login': 'üìÖ Daily Login',
            'ocr_usage': 'üëÅÔ∏è OCR Usage',
            'explore_view': 'üîç Resource Explored',
            'high_rated_file': '‚≠ê High Rated File',
        };

        async function loadDashboard() {
            try {
                // Load user profile
                const userRes = await authFetch('/api/me');
                if (!userRes.ok) { logout(); return; }
                const user = await userRes.json();

                document.getElementById('user-name').textContent = user.name || 'Learner';
                document.getElementById('nav-initial').textContent = (user.name || 'U').charAt(0).toUpperCase();
                document.getElementById('stat-college').textContent = user.college || '‚Äî';
                document.getElementById('stat-tokens').textContent = user.edutokens || 0;
                document.getElementById('stat-explore').textContent = user.explore_score || 0;

                // Load token history
                const tokenRes = await authFetch('/api/tokens/history');
                const tokenData = await tokenRes.json();
                const historyContainer = document.getElementById('token-history');

                if (tokenData.history.length === 0) {
                    historyContainer.innerHTML = '<p style="color:#666; font-size:14px; text-align:center; padding:16px;">No token activity yet. Upload a resource to earn tokens!</p>';
                } else {
                    historyContainer.innerHTML = tokenData.history.slice(0, 8).map(h => `
                        <div style="display:flex; align-items:center; justify-content:space-between; padding:10px 14px; background:rgba(255,255,255,0.03); border-radius:8px;">
                            <span style="font-size:13px; color:#ccc;">${REASON_LABELS[h.reason] || h.reason}</span>
                            <span style="font-weight:700; color:#55D6BE; font-size:14px;">+${h.amount}</span>
                        </div>
                    `).join('');
                }

                // Load my resources
                const resRes = await authFetch('/api/resources?page=1&limit=10');
                const data = await resRes.json();

                const myResources = data.resources.filter(r => r.uploader_id === user._id);
                document.getElementById('stat-resources').textContent = myResources.length;

                const container = document.getElementById('my-resources');
                if (myResources.length === 0) {
                    container.innerHTML = '<p style="color:#666; font-size:14px; text-align:center; padding:24px;">No resources uploaded yet. <a href="/upload" style="color:#55D6BE;">Upload your first!</a></p>';
                    return;
                }

                container.innerHTML = myResources.slice(0, 5).map(r => `
                    <a href="/resource/${r._id}" style="text-decoration:none; color:white;">
                        <div style="display:flex; align-items:center; gap:16px; padding:16px; background:rgba(255,255,255,0.05); border-radius:10px; transition:background 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'">
                            <div style="width:44px; height:44px; border-radius:10px; background:linear-gradient(135deg, #55D6BE, #0F5257); display:flex; align-items:center; justify-content:center;">
                                <i class="fas fa-file-alt" style="color:white;"></i>
                            </div>
                            <div style="flex:1;">
                                <h4 style="font-size:15px; margin-bottom:4px;">${r.title}</h4>
                                <p style="color:#999; font-size:12px;">${r.subject} ¬∑ Sem ${r.semester} ¬∑ ${r.privacy === 'private' ? 'üîí Private' : 'üåç Public'}</p>
                            </div>
                            <span style="color:#666; font-size:11px;">${r.avg_rating ? '‚≠ê ' + r.avg_rating : ''}</span>
                        </div>
                    </a>
                `).join('');
            } catch (e) {
                console.error(e);
            }
        }

        loadDashboard();
    </script>
</body>

</html>