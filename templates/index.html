<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browse Resources - EduHub</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="bg-glow"></div>

    <!-- Navbar -->
    <nav class="navbar">
        <div style="display:flex; align-items:center; gap:12px;">
            <a href="/dashboard" style="display:flex; align-items:center; gap:12px; text-decoration:none; color:white;">
                <img src="/static/images/LOGO_WHITE.png" style="width:32px; height:32px; object-fit:contain;">
                <span style="font-weight:700; font-size:20px;">EduHub</span>
            </a>
        </div>
        <div style="display:flex; align-items:center; gap:20px;">
            <a href="/dashboard" style="color:#ccc; text-decoration:none;">Dashboard</a>
            <a href="/upload" style="color:#ccc; text-decoration:none;">Upload</a>
            <button onclick="logout()" style="background:none; border:none; color:#999; cursor:pointer;"><i
                    class="fas fa-sign-out-alt"></i></button>
        </div>
    </nav>

    <main style="min-height:calc(100vh - 64px); padding:32px; padding-top:96px;">
        <div style="max-width:1100px; margin:0 auto;">
            <h1 style="font-size:28px; margin-bottom:24px;">Browse Resources</h1>

            <!-- Search & Filters -->
            <div class="glass-card" style="border-radius:12px; padding:20px; margin-bottom:28px;">
                <div style="display:flex; gap:12px; margin-bottom:16px;">
                    <input type="text" id="search-input" class="form-input"
                        placeholder="Search by title, subject, or tags..." style="flex:1;">
                    <button onclick="loadResources()" class="btn-primary-custom"
                        style="padding:10px 24px; border-radius:10px; white-space:nowrap;">
                        <i class="fas fa-search"></i> Search
                    </button>
                </div>
                <div style="display:flex; flex-wrap:wrap; gap:12px;">
                    <select id="filter-semester" class="form-input" style="width:auto; min-width:120px;"
                        onchange="loadResources()">
                        <option value="">All Semesters</option>
                        <option value="1">Sem 1</option>
                        <option value="2">Sem 2</option>
                        <option value="3">Sem 3</option>
                        <option value="4">Sem 4</option>
                        <option value="5">Sem 5</option>
                        <option value="6">Sem 6</option>
                        <option value="7">Sem 7</option>
                        <option value="8">Sem 8</option>
                    </select>
                    <select id="filter-type" class="form-input" style="width:auto; min-width:140px;"
                        onchange="loadResources()">
                        <option value="">All Types</option>
                        <option value="notes">Notes</option>
                        <option value="slides">Slides</option>
                        <option value="paper">Past Paper</option>
                        <option value="assignment">Assignment</option>
                        <option value="book">Book</option>
                        <option value="other">Other</option>
                    </select>
                    <select id="filter-privacy" class="form-input" style="width:auto; min-width:120px;"
                        onchange="loadResources()">
                        <option value="">All Access</option>
                        <option value="public">üåç Public</option>
                        <option value="private">üîí Private</option>
                    </select>
                </div>
            </div>

            <!-- Results count -->
            <p id="results-count" style="color:#999; font-size:13px; margin-bottom:16px;"></p>

            <!-- Resource Grid -->
            <div id="resources-grid"
                style="display:grid; grid-template-columns:repeat(auto-fill, minmax(320px, 1fr)); gap:20px;">
                <p style="color:#666; text-align:center; grid-column:1/-1; padding:40px;">Loading resources...</p>
            </div>

            <!-- Pagination -->
            <div id="pagination" style="display:flex; justify-content:center; gap:8px; margin-top:28px;"></div>
        </div>
    </main>

    <script>
        const token = localStorage.getItem('eduhub_token');
        if (!token) window.location.href = '/login';

        function logout() {
            localStorage.removeItem('eduhub_token');
            localStorage.removeItem('eduhub_user');
            window.location.href = '/login';
        }

        let currentPage = 1;

        // Enter key search
        document.getElementById('search-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') loadResources();
        });

        function getTypeIcon(type) {
            const icons = { notes: 'fa-file-alt', slides: 'fa-file-powerpoint', paper: 'fa-file-lines', assignment: 'fa-tasks', book: 'fa-book', other: 'fa-file' };
            return icons[type] || 'fa-file';
        }

        function getTypeColor(type) {
            const colors = { notes: '#55D6BE,#0F5257', slides: '#a855f7,#7c3aed', paper: '#f59e0b,#d97706', assignment: '#3b82f6,#2563eb', book: '#ec4899,#db2777' };
            return colors[type] || '#55D6BE,#0F5257';
        }

        function renderStars(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                stars += `<i class="fas fa-star" style="color:${i <= Math.round(rating) ? '#f59e0b' : '#444'}; font-size:11px;"></i>`;
            }
            return stars;
        }

        async function loadResources(page = 1) {
            currentPage = page;
            const search = document.getElementById('search-input').value;
            const semester = document.getElementById('filter-semester').value;
            const type = document.getElementById('filter-type').value;
            const privacy = document.getElementById('filter-privacy').value;

            let url = `/api/resources?page=${page}&limit=12`;
            if (search) url += `&search=${encodeURIComponent(search)}`;
            if (semester) url += `&semester=${semester}`;
            if (type) url += `&resource_type=${type}`;
            if (privacy) url += `&privacy=${privacy}`;

            try {
                const res = await fetch(url, { headers: { 'Authorization': 'Bearer ' + token } });
                const data = await res.json();

                document.getElementById('results-count').textContent = `${data.total} resource${data.total !== 1 ? 's' : ''} found`;

                const grid = document.getElementById('resources-grid');
                if (data.resources.length === 0) {
                    grid.innerHTML = '<p style="color:#666; text-align:center; grid-column:1/-1; padding:40px;">No resources found. Try a different search.</p>';
                    document.getElementById('pagination').innerHTML = '';
                    return;
                }

                grid.innerHTML = data.resources.map(r => {
                    const colors = getTypeColor(r.resource_type);
                    const tags = (r.tags || []).slice(0, 3).map(t => `<span style="background:rgba(85,214,190,0.15); color:#55D6BE; padding:2px 8px; border-radius:20px; font-size:11px;">${t}</span>`).join('');
                    return `
                    <a href="/resource/${r._id}" style="text-decoration:none; color:white;">
                        <div class="glass-card" style="border-radius:12px; padding:20px; cursor:pointer; border:1px solid transparent; transition:all 0.3s; height:100%;" onmouseover="this.style.borderColor='#55D6BE'; this.style.transform='translateY(-4px)'" onmouseout="this.style.borderColor='transparent'; this.style.transform='translateY(0)'">
                            <div style="display:flex; align-items:flex-start; gap:14px; margin-bottom:12px;">
                                <div style="width:48px; height:48px; border-radius:10px; background:linear-gradient(135deg, ${colors}); display:flex; align-items:center; justify-content:center; flex-shrink:0;">
                                    <i class="fas ${getTypeIcon(r.resource_type)}" style="color:white; font-size:18px;"></i>
                                </div>
                                <div style="flex:1; min-width:0;">
                                    <h3 style="font-size:16px; font-weight:700; margin-bottom:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${r.title}</h3>
                                    <p style="color:#999; font-size:12px;">${r.subject} ¬∑ Sem ${r.semester}</p>
                                </div>
                            </div>
                            ${r.description ? `<p style="color:#aaa; font-size:13px; margin-bottom:12px; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;">${r.description}</p>` : ''}
                            <div style="display:flex; flex-wrap:wrap; gap:6px; margin-bottom:12px;">${tags}</div>
                            <div style="display:flex; align-items:center; justify-content:space-between; font-size:12px; color:#888;">
                                <span>${r.privacy === 'private' ? 'üîí Private' : 'üåç Public'}</span>
                                <span>${r.avg_rating > 0 ? renderStars(r.avg_rating) + ' ' + r.avg_rating : 'No ratings'}</span>
                            </div>
                            <p style="font-size:11px; color:#666; margin-top:8px;"><i class="fas fa-user" style="margin-right:4px;"></i>${r.uploader_name}</p>
                        </div>
                    </a>`;
                }).join('');

                // Pagination
                let paginationHTML = '';
                for (let i = 1; i <= data.pages; i++) {
                    const active = i === page;
                    paginationHTML += `<button onclick="loadResources(${i})" style="padding:8px 14px; border-radius:8px; border:none; cursor:pointer; font-weight:600; background:${active ? '#55D6BE' : 'rgba(255,255,255,0.1)'}; color:${active ? '#32292F' : '#ccc'};">${i}</button>`;
                }
                document.getElementById('pagination').innerHTML = paginationHTML;
            } catch (e) {
                console.error(e);
            }
        }

        loadResources();
    </script>
</body>

</html>