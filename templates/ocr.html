<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR - Image to Text - EduHub</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="bg-glow"></div>

    <nav class="navbar">
        <div style="display:flex; align-items:center; gap:12px;">
            <a href="/dashboard" style="display:flex; align-items:center; gap:12px; text-decoration:none; color:white;">
                <img src="/static/images/LOGO_WHITE.png" style="width:32px; height:32px; object-fit:contain;">
                <span style="font-weight:700; font-size:20px;">EduHub</span>
            </a>
        </div>
        <div style="display:flex; align-items:center; gap:20px;">
            <a href="/dashboard" style="color:#ccc; text-decoration:none;">Dashboard</a>
            <a href="/browse" style="color:#ccc; text-decoration:none;">Browse</a>
            <a href="/community" style="color:#ccc; text-decoration:none;">Community</a>
            <a href="/ocr" style="color:#a855f7; text-decoration:none; font-weight:600;">OCR</a>
            <button onclick="logout()" style="background:none; border:none; color:#999; cursor:pointer;"><i
                    class="fas fa-sign-out-alt"></i></button>
        </div>
    </nav>

    <main style="min-height:calc(100vh - 64px); padding:32px; padding-top:96px;">
        <div style="max-width:700px; margin:0 auto;">
            <div style="text-align:center; margin-bottom:40px;">
                <h1 style="font-size:32px; margin-bottom:8px;"><i class="fas fa-eye"
                        style="color:#a855f7; margin-right:12px;"></i>Image to Text</h1>
                <p style="color:#999; font-size:14px;">Upload an image or PDF and extract text using OCR Â· <span
                        style="color:#55D6BE;">+2 tokens</span></p>
            </div>

            <!-- Upload Area -->
            <div class="glass-card" style="border-radius:12px; padding:32px; margin-bottom:24px;">
                <div class="file-drop-area" id="drop-area" onclick="document.getElementById('ocr-file').click()">
                    <i class="fas fa-image" style="font-size:40px; color:#a855f7; margin-bottom:8px;"></i>
                    <p style="font-weight:600;">Click or drag image/PDF here</p>
                    <p style="color:#999; font-size:12px;">Supports JPG, PNG, BMP, GIF, WebP, PDF (max 5MB)</p>
                    <input type="file" id="ocr-file" accept="image/*,.pdf" style="display:none;">
                </div>

                <div id="preview" style="display:none; margin-top:20px; text-align:center;">
                    <img id="preview-img"
                        style="max-width:100%; max-height:300px; border-radius:10px; border:1px solid rgba(255,255,255,0.1);">
                    <p id="preview-name" style="color:#999; font-size:12px; margin-top:8px;"></p>
                </div>

                <button id="extract-btn" onclick="extractText()" class="btn-primary-custom"
                    style="padding:12px 32px; border-radius:10px; margin-top:20px; width:100%; display:none; font-size:16px;">
                    <i class="fas fa-magic" style="margin-right:8px;"></i> Extract Text
                </button>

                <div id="loading-indicator" style="display:none; text-align:center; padding:20px;">
                    <i class="fas fa-circle-notch fa-spin" style="font-size:28px; color:#a855f7;"></i>
                    <p style="color:#999; margin-top:12px;">Extracting text...</p>
                </div>
            </div>

            <!-- Result -->
            <div id="result-card" class="glass-card" style="border-radius:12px; padding:24px; display:none;">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;">
                    <h3 style="font-weight:700;"><i class="fas fa-file-alt"
                            style="color:#55D6BE; margin-right:8px;"></i>Extracted Text</h3>
                    <button onclick="copyText()" class="btn-outline-custom"
                        style="padding:6px 16px; border-radius:8px; font-size:12px;">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                </div>
                <div id="result-text"
                    style="background:rgba(0,0,0,0.3); border-radius:10px; padding:20px; font-size:14px; line-height:1.8; color:#ddd; white-space:pre-wrap; max-height:400px; overflow-y:auto;">
                </div>
                <p id="token-msg" style="color:#55D6BE; font-size:13px; margin-top:12px; display:none;">
                    <i class="fas fa-coins" style="color:#f59e0b;"></i> +2 EduTokens earned!
                </p>
            </div>

            <!-- History -->
            <div class="glass-card" style="border-radius:12px; padding:24px; margin-top:24px;">
                <h3 style="font-weight:700; margin-bottom:16px;"><i class="fas fa-history"
                        style="color:#a855f7; margin-right:8px;"></i>OCR History</h3>
                <div id="ocr-history" style="display:flex; flex-direction:column; gap:8px;">
                    <p style="color:#666; font-size:14px; text-align:center; padding:16px;">Loading...</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        const token = localStorage.getItem('eduhub_token');
        if (!token) window.location.href = '/login';

        async function authFetch(url, options = {}) {
            options.headers = options.headers || {};
            options.headers['Authorization'] = 'Bearer ' + token;
            return fetch(url, options);
        }

        function logout() {
            localStorage.removeItem('eduhub_token');
            localStorage.removeItem('eduhub_user');
            window.location.href = '/login';
        }

        let selectedFile = null;

        document.getElementById('ocr-file').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;
            selectedFile = file;
            showPreview(file);
        });

        // Drag and drop
        const dropArea = document.getElementById('drop-area');
        ['dragenter', 'dragover'].forEach(evt => {
            dropArea.addEventListener(evt, e => { e.preventDefault(); dropArea.classList.add('active'); });
        });
        ['dragleave', 'drop'].forEach(evt => {
            dropArea.addEventListener(evt, e => { e.preventDefault(); dropArea.classList.remove('active'); });
        });
        dropArea.addEventListener('drop', e => {
            const file = e.dataTransfer.files[0];
            if (file) { selectedFile = file; showPreview(file); }
        });

        function showPreview(file) {
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('preview-img').src = e.target.result;
                document.getElementById('preview').style.display = 'block';
                document.getElementById('preview-name').textContent = file.name;
                document.getElementById('extract-btn').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        async function extractText() {
            if (!selectedFile) return;

            document.getElementById('extract-btn').style.display = 'none';
            document.getElementById('loading-indicator').style.display = 'block';
            document.getElementById('result-card').style.display = 'none';

            const formData = new FormData();
            formData.append('file', selectedFile);

            try {
                const res = await authFetch('/api/ocr/extract', { method: 'POST', body: formData });
                const data = await res.json();

                document.getElementById('loading-indicator').style.display = 'none';

                if (res.ok) {
                    document.getElementById('result-text').textContent = data.text || '(No text detected)';
                    document.getElementById('result-card').style.display = 'block';
                    document.getElementById('token-msg').style.display = 'block';
                    loadHistory();
                } else {
                    alert(data.detail || 'OCR failed');
                    document.getElementById('extract-btn').style.display = 'block';
                }
            } catch (e) {
                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('extract-btn').style.display = 'block';
                alert('Error: ' + e.message);
            }
        }

        function copyText() {
            const text = document.getElementById('result-text').textContent;
            navigator.clipboard.writeText(text).then(() => {
                const btn = event.target.closest('button');
                btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                setTimeout(() => btn.innerHTML = '<i class="fas fa-copy"></i> Copy', 2000);
            });
        }

        async function loadHistory() {
            try {
                const res = await authFetch('/api/ocr/history');
                const data = await res.json();
                const container = document.getElementById('ocr-history');

                if (data.results.length === 0) {
                    container.innerHTML = '<p style="color:#666; font-size:14px; text-align:center; padding:16px;">No OCR history yet</p>';
                    return;
                }

                container.innerHTML = data.results.map(r => `
                    <div style="padding:12px 14px; background:rgba(255,255,255,0.03); border-radius:8px;">
                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px;">
                            <span style="font-weight:600; font-size:13px; color:#ccc;">${r.filename}</span>
                            <span style="color:#666; font-size:11px;">${new Date(r.created_at).toLocaleDateString()}</span>
                        </div>
                        <p style="color:#999; font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${r.extracted_text || '(empty)'}</p>
                    </div>
                `).join('');
            } catch (e) {
                console.error(e);
            }
        }

        loadHistory();
    </script>
</body>

</html>