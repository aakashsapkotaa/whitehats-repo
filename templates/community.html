<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community - EduHub</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        .group-card { background:rgba(255,255,255,0.05); border-radius:14px; padding:20px; border:1px solid rgba(255,255,255,0.08); transition:all 0.3s ease; cursor:pointer; }
        .group-card:hover { border-color:#55D6BE; transform:translateY(-2px); box-shadow:0 4px 20px rgba(85,214,190,0.15); }
        .group-badge { display:inline-block; padding:3px 10px; border-radius:20px; font-size:11px; font-weight:600; }
        .tab-btn { padding:10px 24px; border-radius:10px; border:1px solid transparent; background:rgba(255,255,255,0.05); color:#999; cursor:pointer; font-family:inherit; font-size:14px; font-weight:600; transition:all 0.3s; }
        .tab-btn.active { background:rgba(85,214,190,0.15); color:#55D6BE; border-color:#55D6BE; }
        .tab-btn:hover:not(.active) { color:#ccc; background:rgba(255,255,255,0.1); }
        .member-avatar { width:32px; height:32px; border-radius:50%; background:#0F5257; display:flex; align-items:center; justify-content:center; font-weight:700; color:#55D6BE; font-size:12px; border:2px solid rgba(85,214,190,0.3); }
        .discussion-msg { padding:14px; background:rgba(255,255,255,0.03); border-radius:10px; border-left:3px solid #55D6BE; }
        .category-pill { padding:4px 12px; border-radius:20px; font-size:11px; font-weight:600; background:rgba(168,85,247,0.15); color:#a855f7; }
    </style>
</head>

<body>
    <div class="bg-glow"></div>

    <!-- Navbar -->
    <nav class="navbar">
        <div style="display:flex; align-items:center; gap:12px;">
            <a href="/dashboard" style="display:flex; align-items:center; gap:12px; text-decoration:none; color:white;">
                <img src="/static/images/LOGO_WHITE.png" style="width:32px; height:32px; object-fit:contain;">
                <span style="font-weight:700; font-size:20px;">EduHub</span>
            </a>
        </div>
        <div style="display:flex; align-items:center; gap:20px;">
            <a href="/dashboard" style="color:#ccc; text-decoration:none;">Dashboard</a>
            <a href="/browse" style="color:#ccc; text-decoration:none;">Browse</a>
            <a href="/community" style="color:#55D6BE; text-decoration:none; font-weight:600;">Community</a>
            <a href="/ocr" style="color:#ccc; text-decoration:none;">OCR</a>
            <button onclick="logout()" style="background:none; border:none; color:#999; cursor:pointer;"><i
                    class="fas fa-sign-out-alt"></i></button>
        </div>
    </nav>

    <main style="min-height:calc(100vh - 64px); padding:32px; padding-top:96px;">
        <div style="max-width:900px; margin:0 auto;">

            <!-- Header -->
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:32px;">
                <div>
                    <h1 style="font-size:32px; margin-bottom:6px;"><i class="fas fa-users"
                            style="color:#55D6BE; margin-right:12px;"></i>Community Groups</h1>
                    <p style="color:#999; font-size:14px;">Join study groups, share resources, and collaborate</p>
                </div>
                <button onclick="showCreateModal()" class="btn-primary-custom"
                    style="padding:12px 24px; border-radius:10px; font-size:14px;">
                    <i class="fas fa-plus" style="margin-right:8px;"></i>Create Group
                </button>
            </div>

            <!-- Tabs -->
            <div style="display:flex; gap:10px; margin-bottom:24px;">
                <button class="tab-btn active" onclick="switchTab('all')">All Groups</button>
                <button class="tab-btn" onclick="switchTab('my')">My Groups</button>
            </div>

            <!-- Search -->
            <div style="display:flex; gap:12px; margin-bottom:24px;">
                <input type="text" id="group-search" class="form-input" placeholder="Search groups..."
                    style="flex:1;" oninput="searchGroups()">
                <select id="group-category" class="form-input" style="width:160px;" onchange="searchGroups()">
                    <option value="">All Categories</option>
                    <option value="General">General</option>
                    <option value="Engineering">Engineering</option>
                    <option value="Science">Science</option>
                    <option value="Arts">Arts</option>
                    <option value="Commerce">Commerce</option>
                    <option value="Exam Prep">Exam Prep</option>
                    <option value="Projects">Projects</option>
                </select>
            </div>

            <!-- Groups List -->
            <div id="groups-list" style="display:flex; flex-direction:column; gap:14px;">
                <p style="color:#666; font-size:14px; text-align:center; padding:40px;">Loading groups...</p>
            </div>

            <!-- Group Detail View (hidden initially) -->
            <div id="group-detail" style="display:none;">
                <button onclick="backToList()" style="background:none; border:none; color:#55D6BE; cursor:pointer; font-size:14px; margin-bottom:20px; font-family:inherit;">
                    ← Back to Groups
                </button>

                <div class="glass-card" style="border-radius:14px; margin-bottom:24px;">
                    <div style="display:flex; align-items:flex-start; justify-content:space-between;">
                        <div>
                            <h2 id="detail-name" style="font-size:24px; margin-bottom:6px;"></h2>
                            <p id="detail-desc" style="color:#999; font-size:14px; margin-bottom:12px;"></p>
                            <div style="display:flex; gap:12px; align-items:center;">
                                <span id="detail-category" class="category-pill"></span>
                                <span id="detail-members" style="color:#666; font-size:13px;"></span>
                                <span id="detail-creator" style="color:#666; font-size:13px;"></span>
                            </div>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button id="join-btn" onclick="joinLeaveGroup()" class="btn-primary-custom"
                                style="padding:10px 24px; border-radius:10px;"></button>
                            <button id="delete-group-btn" onclick="deleteGroup()"
                                style="padding:10px 20px; border-radius:10px; background:rgba(255,0,0,0.2); color:#ff6b6b; border:1px solid rgba(255,0,0,0.3); cursor:pointer; display:none;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Members -->
                <div class="glass-card" style="border-radius:14px; padding:20px; margin-bottom:24px;">
                    <h3 style="font-size:16px; margin-bottom:14px;"><i class="fas fa-user-friends"
                            style="color:#a855f7; margin-right:8px;"></i>Members</h3>
                    <div id="detail-member-list" style="display:flex; flex-wrap:wrap; gap:10px;"></div>
                </div>

                <!-- Discussion -->
                <div class="glass-card" style="border-radius:14px; padding:20px; margin-bottom:24px;">
                    <h3 style="font-size:16px; margin-bottom:14px;"><i class="fas fa-comments"
                            style="color:#55D6BE; margin-right:8px;"></i>Discussion</h3>
                    <div id="post-area" style="display:none; margin-bottom:16px;">
                        <div style="display:flex; gap:12px;">
                            <input type="text" id="post-input" class="form-input" placeholder="Write a message..."
                                style="flex:1;" onkeypress="if(event.key==='Enter')postMessage()">
                            <button onclick="postMessage()" class="btn-primary-custom"
                                style="padding:10px 20px; border-radius:10px;">Post</button>
                        </div>
                    </div>
                    <div id="detail-posts" style="display:flex; flex-direction:column; gap:10px;">
                        <p style="color:#666; font-size:14px; text-align:center; padding:16px;">No discussion yet</p>
                    </div>
                </div>

                <!-- Group Resources -->
                <div class="glass-card" style="border-radius:14px; padding:20px;">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:14px;">
                        <h3 style="font-size:16px;"><i class="fas fa-book"
                                style="color:#f59e0b; margin-right:8px;"></i>Shared Resources</h3>
                        <a id="upload-to-group-link" href="/upload" style="color:#55D6BE; font-size:13px; text-decoration:none; display:none;">+ Upload to this group</a>
                    </div>
                    <div id="detail-resources" style="display:flex; flex-direction:column; gap:10px;">
                        <p style="color:#666; font-size:14px; text-align:center; padding:16px;">No resources shared yet</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Create Group Modal -->
    <div id="create-modal"
        style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:100; display:none; align-items:center; justify-content:center;">
        <div class="glass-card" style="width:480px; max-width:90vw; border-radius:16px; position:relative;">
            <button onclick="closeCreateModal()"
                style="position:absolute; top:16px; right:16px; background:none; border:none; color:#666; cursor:pointer; font-size:18px;">
                <i class="fas fa-times"></i>
            </button>
            <h2 style="font-size:20px; margin-bottom:20px;"><i class="fas fa-plus-circle"
                    style="color:#55D6BE; margin-right:10px;"></i>Create Study Group</h2>
            <form id="create-form" style="display:flex; flex-direction:column; gap:16px;">
                <div>
                    <label class="form-label">Group Name</label>
                    <input type="text" id="new-group-name" class="form-input" placeholder="e.g. DSA Masters Sem 4"
                        required>
                </div>
                <div>
                    <label class="form-label">Description</label>
                    <textarea id="new-group-desc" class="form-input" rows="3"
                        placeholder="What's this group about?"></textarea>
                </div>
                <div>
                    <label class="form-label">Category</label>
                    <select id="new-group-cat" class="form-input">
                        <option value="General">General</option>
                        <option value="Engineering">Engineering</option>
                        <option value="Science">Science</option>
                        <option value="Arts">Arts</option>
                        <option value="Commerce">Commerce</option>
                        <option value="Exam Prep">Exam Prep</option>
                        <option value="Projects">Projects</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary-custom"
                    style="padding:14px; border-radius:12px; font-size:15px;">
                    <i class="fas fa-rocket" style="margin-right:8px;"></i>Create Group
                </button>
            </form>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('eduhub_token');
        if (!token) window.location.href = '/login';

        let currentTab = 'all';
        let currentGroupId = null;
        let currentGroupData = null;

        async function authFetch(url, options = {}) {
            options.headers = options.headers || {};
            options.headers['Authorization'] = 'Bearer ' + token;
            return fetch(url, options);
        }

        function logout() {
            localStorage.removeItem('eduhub_token');
            localStorage.removeItem('eduhub_user');
            window.location.href = '/login';
        }

        // --- Tabs ---
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach((b, i) => {
                b.classList.toggle('active', (i === 0 && tab === 'all') || (i === 1 && tab === 'my'));
            });
            loadGroups();
        }

        // --- Load Groups ---
        async function loadGroups() {
            const search = document.getElementById('group-search').value;
            const category = document.getElementById('group-category').value;
            const url = currentTab === 'my'
                ? '/api/groups/my'
                : `/api/groups?${new URLSearchParams({ search, category }).toString()}`;

            try {
                const res = await authFetch(url);
                const data = await res.json();
                renderGroups(data.groups);
            } catch (e) {
                console.error(e);
            }
        }

        function searchGroups() {
            if (currentTab === 'all') loadGroups();
        }

        function renderGroups(groups) {
            const container = document.getElementById('groups-list');
            if (groups.length === 0) {
                container.innerHTML = `<div style="text-align:center; padding:60px;">
                    <i class="fas fa-users" style="font-size:48px; color:#444; margin-bottom:16px;"></i>
                    <p style="color:#666; font-size:15px;">${currentTab === 'my' ? 'You haven\'t joined any groups yet' : 'No groups found'}</p>
                    <button onclick="showCreateModal()" class="btn-outline-custom" style="padding:10px 24px; border-radius:10px; margin-top:16px;">Create the first one!</button>
                </div>`;
                return;
            }

            const CATEGORY_COLORS = {
                'Engineering': '#55D6BE', 'Science': '#a855f7', 'Exam Prep': '#f59e0b',
                'Projects': '#3b82f6', 'Arts': '#ec4899', 'Commerce': '#10b981', 'General': '#6b7280'
            };

            container.innerHTML = groups.map(g => `
                <div class="group-card" onclick="openGroup('${g._id}')">
                    <div style="display:flex; align-items:flex-start; justify-content:space-between;">
                        <div style="flex:1;">
                            <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
                                <h3 style="font-size:17px; font-weight:700;">${g.name}</h3>
                                <span class="category-pill" style="background:${CATEGORY_COLORS[g.category] || '#6b7280'}22; color:${CATEGORY_COLORS[g.category] || '#6b7280'};">${g.category || 'General'}</span>
                            </div>
                            <p style="color:#999; font-size:13px; margin-bottom:10px;">${g.description || 'No description'}</p>
                            <div style="display:flex; align-items:center; gap:16px;">
                                <span style="color:#666; font-size:12px;"><i class="fas fa-users" style="margin-right:6px; color:#55D6BE;"></i>${g.member_count || 0} members</span>
                                <span style="color:#666; font-size:12px;"><i class="fas fa-user" style="margin-right:6px;"></i>by ${g.creator_name || 'Unknown'}</span>
                            </div>
                        </div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            ${g.is_member ? '<span style="padding:6px 14px; border-radius:20px; font-size:11px; font-weight:600; background:rgba(85,214,190,0.15); color:#55D6BE;">✓ Joined</span>' : '<span style="padding:6px 14px; border-radius:20px; font-size:11px; font-weight:600; background:rgba(255,255,255,0.05); color:#999;">Join</span>'}
                            <i class="fas fa-chevron-right" style="color:#444;"></i>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // --- Open Group Detail ---
        async function openGroup(groupId) {
            currentGroupId = groupId;
            document.getElementById('groups-list').style.display = 'none';
            document.querySelectorAll('.tab-btn').forEach(b => b.style.display = 'none');
            document.getElementById('group-search').parentElement.style.display = 'none';
            document.getElementById('group-detail').style.display = 'block';

            try {
                const res = await authFetch('/api/groups/' + groupId);
                const data = await res.json();
                currentGroupData = data;
                const g = data.group;

                document.getElementById('detail-name').textContent = g.name;
                document.getElementById('detail-desc').textContent = g.description || 'No description';
                document.getElementById('detail-category').textContent = g.category || 'General';
                document.getElementById('detail-members').innerHTML = `<i class="fas fa-users" style="margin-right:4px;"></i>${g.member_count || 0} members`;
                document.getElementById('detail-creator').innerHTML = `<i class="fas fa-crown" style="margin-right:4px; color:#f59e0b;"></i>Created by ${g.creator_name}`;

                // Join/Leave button
                const joinBtn = document.getElementById('join-btn');
                if (g.is_member) {
                    joinBtn.textContent = 'Leave Group';
                    joinBtn.style.background = 'rgba(255,0,0,0.2)';
                    joinBtn.style.color = '#ff6b6b';
                    joinBtn.style.border = '1px solid rgba(255,0,0,0.3)';
                    document.getElementById('post-area').style.display = 'block';
                    document.getElementById('upload-to-group-link').style.display = 'block';
                    document.getElementById('upload-to-group-link').href = '/upload?group=' + groupId;
                } else {
                    joinBtn.textContent = 'Join Group';
                    joinBtn.style.background = '';
                    joinBtn.style.color = '';
                    joinBtn.style.border = '';
                    joinBtn.className = 'btn-primary-custom';
                    document.getElementById('post-area').style.display = 'none';
                    document.getElementById('upload-to-group-link').style.display = 'none';
                }

                // Show delete for creator
                const meRes = await authFetch('/api/me');
                const me = await meRes.json();
                document.getElementById('delete-group-btn').style.display = g.creator_id === me._id ? 'block' : 'none';
                // Hide Leave for creator
                if (g.creator_id === me._id && g.is_member) {
                    joinBtn.style.display = 'none';
                }

                // Members
                const memberList = document.getElementById('detail-member-list');
                memberList.innerHTML = data.members.map(m => `
                    <div style="display:flex; align-items:center; gap:8px; padding:6px 12px; background:rgba(255,255,255,0.05); border-radius:20px;">
                        <div class="member-avatar">${(m.name || 'U').charAt(0).toUpperCase()}</div>
                        <span style="font-size:13px; color:#ccc;">${m.name}</span>
                    </div>
                `).join('') || '<p style="color:#666; font-size:13px;">No members yet</p>';

                // Posts
                const postsDiv = document.getElementById('detail-posts');
                if (data.posts.length > 0) {
                    postsDiv.innerHTML = data.posts.map(p => `
                        <div class="discussion-msg">
                            <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                                <div class="member-avatar" style="width:24px; height:24px; font-size:10px;">${(p.user_name || 'U').charAt(0).toUpperCase()}</div>
                                <span style="font-weight:600; font-size:13px; color:#ccc;">${p.user_name}</span>
                                <span style="color:#555; font-size:11px; margin-left:auto;">${new Date(p.created_at).toLocaleString()}</span>
                            </div>
                            <p style="color:#ddd; font-size:14px; margin-left:32px;">${p.text}</p>
                        </div>
                    `).join('');
                } else {
                    postsDiv.innerHTML = '<p style="color:#666; font-size:14px; text-align:center; padding:16px;">No discussion yet. Be the first to post!</p>';
                }

                // Resources
                const resDiv = document.getElementById('detail-resources');
                if (data.resources.length > 0) {
                    resDiv.innerHTML = data.resources.map(r => `
                        <a href="/resource/${r._id}" style="text-decoration:none; color:white;">
                            <div style="display:flex; align-items:center; gap:14px; padding:14px; background:rgba(255,255,255,0.05); border-radius:10px; transition:background 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'">
                                <div style="width:40px; height:40px; border-radius:10px; background:linear-gradient(135deg,#55D6BE,#0F5257); display:flex; align-items:center; justify-content:center;">
                                    <i class="fas fa-file-alt" style="color:white; font-size:14px;"></i>
                                </div>
                                <div style="flex:1;">
                                    <h4 style="font-size:14px; margin-bottom:3px;">${r.title}</h4>
                                    <p style="color:#999; font-size:12px;">${r.subject} · Sem ${r.semester} · by ${r.uploader_name}</p>
                                </div>
                                <span style="color:#666; font-size:11px;">${r.avg_rating ? '⭐ ' + r.avg_rating : ''}</span>
                            </div>
                        </a>
                    `).join('');
                } else {
                    resDiv.innerHTML = '<p style="color:#666; font-size:14px; text-align:center; padding:16px;">No resources shared yet</p>';
                }

            } catch (e) {
                console.error(e);
                alert('Failed to load group');
                backToList();
            }
        }

        function backToList() {
            document.getElementById('group-detail').style.display = 'none';
            document.getElementById('groups-list').style.display = 'flex';
            document.querySelectorAll('.tab-btn').forEach(b => b.style.display = '');
            document.getElementById('group-search').parentElement.style.display = 'flex';
            currentGroupId = null;
            loadGroups();
        }

        // --- Join / Leave ---
        async function joinLeaveGroup() {
            if (!currentGroupData) return;
            const isMember = currentGroupData.group.is_member;
            const action = isMember ? 'leave' : 'join';

            const res = await authFetch(`/api/groups/${currentGroupId}/${action}`, { method: 'POST' });
            const data = await res.json();
            if (res.ok) {
                openGroup(currentGroupId);
            } else {
                alert(data.detail || 'Action failed');
            }
        }

        // --- Post Message ---
        async function postMessage() {
            const input = document.getElementById('post-input');
            const text = input.value.trim();
            if (!text) return;

            const res = await authFetch(`/api/groups/${currentGroupId}/post`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text })
            });
            if (res.ok) {
                input.value = '';
                openGroup(currentGroupId);
            } else {
                const data = await res.json();
                alert(data.detail || 'Failed to post');
            }
        }

        // --- Delete Group ---
        async function deleteGroup() {
            if (!confirm('Are you sure you want to delete this group? All discussions will be lost.')) return;
            const res = await authFetch(`/api/groups/${currentGroupId}`, { method: 'DELETE' });
            if (res.ok) {
                backToList();
            } else {
                const data = await res.json();
                alert(data.detail || 'Failed to delete');
            }
        }

        // --- Create Modal ---
        function showCreateModal() {
            document.getElementById('create-modal').style.display = 'flex';
        }
        function closeCreateModal() {
            document.getElementById('create-modal').style.display = 'none';
        }

        document.getElementById('create-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            const name = document.getElementById('new-group-name').value.trim();
            const description = document.getElementById('new-group-desc').value.trim();
            const category = document.getElementById('new-group-cat').value;

            if (!name) return;

            const res = await authFetch('/api/groups', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, description, category })
            });
            const data = await res.json();
            if (res.ok) {
                closeCreateModal();
                this.reset();
                loadGroups();
            } else {
                alert(data.detail || 'Failed to create group');
            }
        });

        // Close modal on background click
        document.getElementById('create-modal').addEventListener('click', function (e) {
            if (e.target === this) closeCreateModal();
        });

        // Init
        loadGroups();
    </script>
</body>

</html>
